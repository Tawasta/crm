<?xml version="1.0"?>
<openerp>
    <data>

        <!-- Claim stage changes menu action -->
        <record model="ir.actions.act_window" id="action_crm_claim_stage_change">
            <field name="name">Claim stage changes</field>
            <field name="res_model">crm.claim.stage.change</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,graph</field>
            <field name="context">{'search_default_groupby_claim_partner': 1, 'search_default_groupby_claim': 1, 'search_default_groupby_stage': 1, 'search_default_year_this': 1, 'search_default_month_last': 1, 'search_default_month_this': 1}</field>
        </record>

        <menuitem name="Stage changes" id="menu_crm_claim_stage_changes" parent="base.menu_aftersale" action="action_crm_claim_stage_change" sequence="40" groups="base.group_user"/>

        <record model="ir.ui.view" id="crm_claim.crm_claim_stage_change_tree">
            <field name="name">Claim stage changes tree view</field>
            <field name="model">crm.claim.stage.change</field>
            <field name="arch" type="xml">

                <tree string='Stage changes' readonly='1' default_order='claim_date, claim_message_last_post'>
                    <field name='claim_partner_id' />
                    <field name='claim_date' />
                    <field name='claim_id' />
                    <field name='claim_sla' />
                    <field name='claim_message_last_post' />
                    <field name='stage' string='Stage'/>
                    <field name='hours' widget="float_time" sum='Total hours'/>
                </tree>

            </field>
        </record>

        <record model="ir.ui.view" id="crm_claim.crm_claim_stage_change_graph">
            <field name="name">Claim stage changes graph view</field>
            <field name="model">crm.claim.stage.change</field>
            <field name="arch" type="xml">

                <graph string="Claims Analysis" type="pivot">
                     <field name="claim_partner_id" type="row"/>
                     <field name="hours" type="measure"/>
                     <field name="claim_date" interval="month" type="col"/>
                 </graph>
            </field>
        </record>
        
        <record model="ir.ui.view" id="crm_claim.crm_claim_stage_change_filters">
            <field name="name">Claim stage changes tree filters</field>
            <field name="model">crm.claim.stage.change</field>
            <field name="arch" type="xml">

                <search string="Search stage changes">
                    <field name="claim_id" />
                    <field name="claim_sla" />

                    <separator />

                    <group string="Year">
                            <filter string="This year" name="year_this" domain="['&amp;',('claim_date','&lt;=', time.strftime('%Y-12-31')),('claim_date','&gt;=',time.strftime('%Y-01-01'))]"/>
                            <filter string="Last year" name="year_last" domain="[('claim_date','&gt;=',(context_today()-relativedelta(years=1)).strftime('%Y-01-01')),('claim_date','&lt;', time.strftime('%Y-01-01'))]"/>
                    </group>
                    <group string="Month">
                        <filter string="This month" name="month_this" domain="[('claim_date','&lt;',(context_today()+relativedelta(months=1)).strftime('%Y-%m-01')), ('claim_date','&gt;=',time.strftime('%Y-%m-01'))]"/>
                        <filter string="Last month" name="month_last" domain="[('claim_date','&gt;=',(context_today()-relativedelta(months=1)).strftime('%Y-%m-01')),('claim_date','&lt;',time.strftime('%Y-%m-01'))]"/>
                    </group>

                    <group expand="0" string="Group By">
                        <filter name="groupby_claim_partner" string="Claim partner" context="{'group_by':'claim_partner_id'}"/>
                        <filter name="groupby_claim" string="Claim" context="{'group_by':'claim_id'}"/>
                        <filter name="groupby_stage" string="Stage" context="{'group_by':'stage'}"/>
                    </group>
                </search>

            </field>
        </record>
    </data>
</openerp>
